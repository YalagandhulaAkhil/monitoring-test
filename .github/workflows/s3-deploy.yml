name: Deploy S3 Module

on:
  workflow_dispatch:

jobs:
  deploy-s3:
    runs-on: ubuntu-latest

    # ‚úÖ Set all common environment variables from your GitHub Secrets
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
      OUTPUT_S3_BUCKET: ${{ secrets.OUTPUT_S3_BUCKET }}
      OUTPUT_S3_KEY: ${{ secrets.OUTPUT_S3_KEY }}

      TF_VAR_AWS_REGION: ${{ secrets.TF_VAR_AWS_REGION }}
      TF_VAR_PROJECT: ${{ secrets.TF_VAR_PROJECT }}
      TF_VAR_KEY_NAME: ${{ secrets.TF_VAR_KEY_NAME }}
      TF_VAR_ALARM_TOPIC_ARN: ${{ secrets.TF_VAR_ALARM_TOPIC_ARN }}
      TF_VAR_ENVIRONMENT: ${{ secrets.TF_VAR_ENVIRONMENT }}

    defaults:
      run:
        # üëá Folder where your dev environment main.tf is located
        working-directory: ${{ github.workspace }}/environments/dev

    steps:
      # üßæ 1Ô∏è‚É£ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # üîç 2Ô∏è‚É£ Debug folder path (helpful once, keep for visibility)
      - name: Verify repository structure
        run: |
          echo "GitHub workspace: $GITHUB_WORKSPACE"
          pwd
          ls -R $GITHUB_WORKSPACE

      # ‚öôÔ∏è 3Ô∏è‚É£ Setup Terraform
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      # üîë 4Ô∏è‚É£ Configure AWS credentials (for Terraform + AWS CLI)
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_DEFAULT_REGION }}

      # üß© 5Ô∏è‚É£ Initialize Terraform
      - name: Terraform Init
        run: terraform init

      # üß™ 6Ô∏è‚É£ Validate configuration
      - name: Terraform Validate
        run: terraform validate

      # üì¶ 7Ô∏è‚É£ Plan only S3 module
      - name: Terraform Plan - S3 Module
        run: terraform plan -target=module.s3 -out=tfplan

      # üöÄ 8Ô∏è‚É£ Apply only S3 module
      - name: Terraform Apply - S3 Module
        run: terraform apply -auto-approve -target=module.s3

      # üì§ 9Ô∏è‚É£ Push Terraform outputs to your output S3 bucket
      - name: Push Terraform Outputs to S3
        run: |
          echo "Pushing Terraform outputs to S3 bucket: $OUTPUT_S3_BUCKET"
          python3 ../../scripts/push_module_outputs.py

      # ‚úÖ üîü Verify upload
      - name: Verify Upload in S3
        run: |
          echo "Listing output files from S3:"
          aws s3 ls s3://$OUTPUT_S3_BUCKET/module-outputs/ --recursive
